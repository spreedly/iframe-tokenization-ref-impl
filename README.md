# Iframe Tokenization Certificate Generator

This tool simplifies the process of generating a Spreedly certificate for iframe tokenization. It automates the certificate creation, signing, and registration with Spreedly's API.

## Prerequisites

- Docker installed on your system ([Get Docker](https://docs.docker.com/get-docker/))
- Your Spreedly environment key and access credentials, with secure tokenization enabled.

## Quick Start

Once the image is built, run these commmands, replacing the values accordingly:
- `your_env_key`: Your Spreedly environment key, login to obtain. ONLY USE Non-Production values to test.
- `your_access_key`: Your Spreedly access token or key. ONLY USE Non-Production values to test.
- `your_domain_name`: The domain for which you're generating the certificate (e.g., payment.example.com)

```shell
ENV_KEY=your_env_key
ACCESS_KEY=your_access_key
DOMAIN_NAME=your_domain_name
```

## Building Locally

To build the image:

```bash
# Clone the repository
git clone https://github.com/spreedly/iframe-tokenization-ref-impl.git
cd iframe-tokenization-ref-impl

# Build the Docker image
docker build --no-cache -t iframe-tokenization-ref-impl .
```

Run the container:

```shell
docker run -e ENV_KEY=$ENV_KEY -e ACCESS_KEY=$ACCESS_KEY -e DOMAIN_NAME=$DOMAIN_NAME iframe-tokenization-ref-impl
```

Alternatively, you can start the container and run the script manually. 

```shell
docker run -it --entrypoint /bin/sh -e ENV_KEY=$ENV_KEY -e ACCESS_KEY=$ACCESS_KEY -e DOMAIN_NAME=$DOMAIN_NAME iframe-tokenization-ref-impl
```

Then execute the script:
```shell
./create-cert.sh
```

## Output

The reference implementation tool will output:
- A randomly generated nonce
- Your certificate token
- A timestamp
- A server-generated HMAC signature

## How It Works

1. The tool generates a private/public key pair and certificate
2. Registers the ONE-TIME use certificate with Spreedly using your credentials
3. Creates a cryptographic signature for iframe tokenization
4. Runs 2 reference implementations, OpenSSL and Ruby on AlpineLinux, and outputs one time usage values you can use to test your implementation:
```bash
AUTHORIZATION_BASIC: <your values, base64-encoded>
--------------------------------
NONCE (randomly generated): 17bb4cf0-f0f1-4bf6-8441-54ef5b7a0732
TIMESTAMP: 1743812581
CERTIFICATE_TOKEN: 1GN73W0DRY9Y5RZB3DAMVJ7NCV
--------------------------------
SERVER_GENERATED_HMAC (OpenSSL): eSDnIO9GTanzV+i3MkRjWqkASRVoNkcyLvm/tt18nNI=
--------------------------------
SERVER_GENERATED_HMAC (Ruby): eSDnIO9GTanzV+i3MkRjWqkASRVoNkcyLvm/tt18nNI=
```
5. Initialize Spreedly iFrame, e.g.:

```javascript
Spreedly.init("<Environment Key>", {  
  "numberEl": "spreedly-number",  
  "cvvEl": "spreedly-cvv",  
  "nonce": "<<NONCE>>>>",  // Generated by you on your server. Unique per session (e.g., UUID)  
  "certificateToken": "<<CERTIFICATE_TOKEN>>",
  "timestamp": "1738252535", // Current timestamp
  "signature": "<<SERVER_GENERATED_HMAC>>"
});
```


## Security Notes

- Your credentials are used only at runtime and are not stored in the image
- All cryptographic operations happen inside the container
- Private keys are not persisted after the container exits

## Troubleshooting

**Certificate Registration Fails**
- Verify your ENV_KEY and ACCESS_KEY are correct
- Ensure the DOMAIN_NAME matches your actual domain

**Other Issues**
- Try rebuilding with `--no-cache` to ensure a fresh build
- Check that your Docker installation is up to date

** Debugging **

```shell
DOCKER_HOST_IP=$(ifconfig en0 | grep inet | awk '$1=="inet" {print $2}')
TEST_URL=<<for Spreedly internal Use Only>>
docker run --add-host=$TEST_URL:$DOCKER_HOST_IP -e ENV_KEY=$ENV_KEY -e ACCESS_KEY=$ACCESS_KEY -e DOMAIN_NAME=$DOMAIN_NAME -e SPREEDLY_ENDPOINT="http://core.spreedly.test:8090"  iframe-tokenization-ref-impl
```

## License

Copyright Â© 2025 Spreedly. All rights reserved.